<!DOCTYPE html>
<html>
<head>
    <title>US Electric Generation</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        html, body { padding: 0; margin: 0 }
        #map { position: fixed; top:0; bottom: 0; width: 70%; }
        #year-text { position: fixed; bottom: 20px; left: 10px; color: white; }

        #features {
            width: 30%;
            position: absolute;
            margin-left: 70%;
            font-family: sans-serif;
            overflow-y: scroll;
            background-color: #fafafa;
        }
        section {
            padding:  25px 50px;
            line-height: 25px;
            border-bottom: 1px solid #ddd;
            opacity: 0.5;
            font-size: 13px;
        }
        section.active {
            opacity: 1;
        }
        section:last-child {
            border-bottom: none;
        }

        .panel {
            background-color: rgba(255,255,255,0.9);
        }

        .date {
            font-family: monospace;
        }

        /* from https://stackoverflow.com/questions/18325779/bootstrap-3-collapse-show-state-with-chevron-icon*/
        .panel-heading .accordion-toggle:after {
            /* symbol for "opening" panels */
            font-family: 'Glyphicons Halflings';  /* essential for enabling glyphicon */
            content: "\e114";    /* adjust as needed, taken from bootstrap.css */
            float: right;        /* adjust as needed */
            color: grey;         /* adjust as needed */
            font-size: 25px;
        }
        .panel-heading .accordion-toggle.collapsed:after {
            /* symbol for "collapsed" panels */
            content: "\e080";    /* adjust as needed, taken from bootstrap.css */
            font-size: 25px;
        }

        /* from http://danielstern.ca/range.css/?ref=css-tricks#/ */
        input[type=range] {
          -webkit-appearance: none;
          width: 100%;
          margin: 13.8px 0;
        }
        input[type=range]:focus {
          outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%;
          height: 8.4px;
          cursor: pointer;
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
          background: #3071a9;
          border-radius: 1.3px;
          border: 0.2px solid #010101;
        }
        input[type=range]::-webkit-slider-thumb {
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
          border: 1px solid #000000;
          height: 36px;
          width: 16px;
          border-radius: 3px;
          background: #faffff;
          cursor: pointer;
          -webkit-appearance: none;
          margin-top: -14px;
        }
        input[type=range]:focus::-webkit-slider-runnable-track {
          background: #367ebd;
        }
        input[type=range]::-moz-range-track {
          width: 100%;
          height: 8.4px;
          cursor: pointer;
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
          background: #3071a9;
          border-radius: 1.3px;
          border: 0.2px solid #010101;
        }
        input[type=range]::-moz-range-thumb {
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
          border: 1px solid #000000;
          height: 36px;
          width: 16px;
          border-radius: 3px;
          background: #faffff;
          cursor: pointer;
        }
        input[type=range]::-ms-track {
          width: 100%;
          height: 8.4px;
          cursor: pointer;
          background: transparent;
          border-color: transparent;
          color: transparent;
        }
        input[type=range]::-ms-fill-lower {
          background: #2a6495;
          border: 0.2px solid #010101;
          border-radius: 2.6px;
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
        }
        input[type=range]::-ms-fill-upper {
          background: #3071a9;
          border: 0.2px solid #010101;
          border-radius: 2.6px;
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
        }
        input[type=range]::-ms-thumb {
          box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
          border: 1px solid #000000;
          height: 36px;
          width: 16px;
          border-radius: 3px;
          background: #faffff;
          cursor: pointer;
          height: 8.4px;
        }
        input[type=range]:focus::-ms-fill-lower {
          background: #3071a9;
        }
        input[type=range]:focus::-ms-fill-upper {
          background: #367ebd;
        }

    </style>
</head>

<body>
<div id='map'></div>
<h1 id="year-text" class="date">2001</h1>
<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true" style="position: fixed; margin: 0px 10px; width: 68%">
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingOne">
        <a class="accordion-toggle collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne"></a>
        <div style="margin-left: 0px; margin-right: 40px">
            <input id="month" type="range" min="0" max="203" value="0" step=".25"/>
        </div>
    </div>
    <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
        <div class="panel-body" style="padding: 10px; display: table; width: 100%">
            <h4 style="display: table-cell">US Electric Generation &mdash; <span id="month-text" class="date">Jan 2001</span></h4>
            <div style="display: table-cell">
                <div style="float: right">
                    <select id="fuel">
                        <option value="all fuels" selected>All Fuels (4012 TWh)</option>
                        <option value="0">Natural Gas (1304 TWh)</option>
                        <option value="1">Coal (1202 TWh)</option>
                        <option value="2">Nuclear (805 TWh)</option>
                        <option value="3">Hydro (292 TWh)</option>
                        <option value="4">Wind (252 TWh)</option>
                        <option value="6">Renewable Hydrocarbon (56 TWh)</option>
                        <option value="5">Solar (52 TWh)</option>
                        <option value="7">Other (19 TWh)</option>
                        <option value="8">Geothermal (16 TWh)</option>
                        <option value="9">Petroleum (14 TWh)</option>
                    </select>
                    &nbsp;<em>(weighted by 2017 generation)</em>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<div id='features'>
    <section id='intro' class='active'>
        <h3>68 Petawatt Hours</h3>
        <p>Over the last 17 years, overall US electricity generation has been relatively stable at around 4 PWh/year, reflecting increasing energy efficiency even as our economy continues to grow. However, that relative stability belies massive changes in our energy infrastructure.</p>
    </section>
    <section id='coal'>
        <h3>The Decline of Coal</h3>
        <p>The rapidly eroding economic competitiveness of coal has been the biggest constraint on US carbon dioxide emissions. Coal has dropped from around half of total electricity generation to just over a quarter.</p>
    </section>
    <section id='gas'>
        <h3>The Rise of Gas</h3>
        <p>The decline of coal was driven by the rise of cheap natural gas. Relative to coal power stations, natural gas power stations are somewhat cheaper and somewhat more flexible. As a result, it has been relatively "easy" to accomplish this massive rebuilding of our energy infrastructure &mdash; but in any serious proposal to fight climate change, we'll need to shut these plants down well before they've reached the end of their lives.</p>
    </section>
    <section id='solar'>
        <h3>The Rise of Solar</h3>
        <p>After spending decades as a "speculative" energy source dependendent on subsidies, solar power has exploded in the last decade, and is now the cheapest source of power in some situations. However, solar is still a relatively small fraction of overall electricity generation, and its intermittent nature will make it harder to continue integrating greater amounts of solar power. While people across the country install solar panels on their roofs, the utility-scale industry is centered in the desert southwest, with its near-perfect conditions.</p>
    </section>
    <section id='wind'>
        <h3>The Rise of Wind</h3>
        <p>In parallel to the rise of solar, wind generation has skyrocketed, dominated by the states of the windswept Great Plains, where wind generation is now one of the larger electricity sources. Wind also suffers from intermittency, but luckily for us sunshine and wind are not highly correlated &mdash; so wind can balance out some of the intermittency of solar.</p>
    </section>
    <section id='hydro'>
        <h3>Hydroelectric's Changing Role</h3>
        <p>Large hydroelectric plants are still a major source of carbon-free electricity, especially in the Pacific Northwest. With many of the best dam sites already "taken", there is less scope for growth, but hydroelectic plants are starting to find a new role as "batteries" which can soak up excess wind and solar generation by pumping water up-hill. Unfortunately, operating these "batteries" requires reliable precipitation, and throughout the West snow and rainfall are becoming more erratic.</p>
    </section>
    <section id='nuclear-solar'>
        <h3>Neglected Nuclear</h3>
        <p>Over this entire time period, nuclear generating stations have generated roughly 20% of our electricity &mdash; making up the majority of our carbon-free electricity, even after the rapid growth of renewables. They are safe, they are compact, and they do not suffer from intermittency. Disastrously, the US has stalled building new nuclear plants and has even started to retire some plants early. California is slated to close its last nuclear power plant by 2024. New nuclear plants have failed due to economic constraints (especially competition against cheap-but-polluting gas), but we know that countries such as France and Sweden have switched almost entirely to nuclear power at reasonable cost. If we're going to have a chance against climate change, we need policies (such as a price on carbon) to support a massive build-out of new nuclear plants.</p>
    </section>
    <section id='explore' style="height: 100vh">
        <h3>Explore</h3>
        <p>Use the controls to filter by fuel source and move through time. Zoom in to see data on individual plants, along with satellite imagery. What interesting patterns do you see?</p>
        <p><em>See <a>"How I built it"</a></em></p>
        <small id="citation">
            Data sourced from <a href='https://www.eia.gov/electricity/data/eia923/'>US Energy Information Administration</a>.
        </small>
    </section>
</div>

<script>


mapboxgl.accessToken = 'pk.eyJ1IjoiY2hyaXNsb2VyIiwiYSI6ImNpdGo5aW11OTA3OWkyc252OTU2b29zM3IifQ.u2B_kCe8kOg0Eky8yC0U4Q';

var map = window.map = new mapboxgl.Map({
    container: 'map',
    zoom: 4,
    center: [-99.79, 38.92],
    style: 'mapbox://styles/mapbox/dark-v10',
    hash: true,
    maxBounds: [
        [-140, 5], // Southwest coordinates
        [-50, 65]  // Northeast coordinates
    ]

});

// From https://www.npmjs.com/package/mapbox-gl-utils
function setLayerSource (layerId, source, sourceLayer) {
    const oldLayers = map.getStyle().layers;
    const layerIndex = oldLayers.findIndex(l => l.id === layerId);
    const layerDef = oldLayers[layerIndex];
    const before = oldLayers[layerIndex + 1] && oldLayers[layerIndex + 1].id;
    layerDef.source = source;
    if (sourceLayer) {
        layerDef['source-layer'] = sourceLayer;
    }
    map.removeLayer(layerId);
    map.addLayer(layerDef, before);
}

map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');
map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

var monthInput = document.getElementById('month');
var monthText = document.getElementById('month-text');
var yearText = document.getElementById('year-text');
var fuelSelect = document.getElementById('fuel');

const baseIntensity = 1;
const baseRadius = 16;

map.on('load', function() {
    map.addSource('satellite', {
        "type": "raster",
         "url": "mapbox://mapbox.satellite",
        "tileSize": 256
    });

    map.addSource('plant-generation', {
        "type": "vector",
        "url": "mapbox://chrisloer.5yh8m2ka"
    });

    map.addSource('quarterly-generation-all', {
        "type": "vector",
        "url": "mapbox://chrisloer.9v4ety4d"
    });
    map.addSource('quarterly-generation-gas', {
        "type": "vector",
        "url": "mapbox://chrisloer.5vva62hd"
    });
    map.addSource('quarterly-generation-coal', {
        "type": "vector",
        "url": "mapbox://chrisloer.3goocsnw"
    });
    map.addSource('quarterly-generation-nuclear', {
        "type": "vector",
        "url": "mapbox://chrisloer.aa153gkx"
    });
    map.addSource('quarterly-generation-hydro', {
        "type": "vector",
        "url": "mapbox://chrisloer.9bb3s0f0"
    });
    map.addSource('quarterly-generation-wind', {
        "type": "vector",
        "url": "mapbox://chrisloer.3o674uex"
    });
    map.addSource('quarterly-generation-solar', {
        "type": "vector",
        "url": "mapbox://chrisloer.8k295r49"
    });
    map.addSource('quarterly-generation-renewable', {
        "type": "vector",
        "url": "mapbox://chrisloer.1p4pqjk0"
    });
    map.addSource('quarterly-generation-other', {
        "type": "vector",
        "url": "mapbox://chrisloer.8ffwhxz3"
    });
    map.addSource('quarterly-generation-geothermal', {
        "type": "vector",
        "url": "mapbox://chrisloer.8w5wg42y"
    });
    map.addSource('quarterly-generation-petroleum', {
        "type": "vector",
        "url": "mapbox://chrisloer.6z5qna0c"
    });

    map.addLayer({
        "id": "satellite",
        "source": "satellite",
        "type": "raster",
        "minzoom": 8,
        "paint": {
            "raster-brightness-max": 0.5,
            "raster-opacity": [
              "interpolate",
              ["linear"],
              [ "zoom" ],
              0,
              0,
              8,
              0,
              12,
              1
            ]
        }
    }, 'road-label');

    map.addLayer({
        "id": "generation-heatmap",
        "type": "heatmap",
        "source": "quarterly-generation-all",
        "source-layer": "geojsonLayer",
        "maxzoom": 10,
        "paint": {
            'heatmap-radius': [
              "interpolate",
              [ "exponential", 2 ],
              [ "zoom" ],
              0,
              baseRadius,
              16,
              baseRadius * 256
            ],
            'heatmap-intensity': [
              "interpolate",
              [ "exponential", 2 ],
              [ "zoom" ],
              0,
              baseIntensity,
              16,
              16 * baseIntensity
            ],
            'heatmap-intensity-transition': {
                "duration": 300,
                "delay": 0
            },
            'heatmap-opacity': [
              "interpolate",
              ["linear"],
              [ "zoom" ],
              0,
              1,
              8,
              1,
              10,
              0
            ],
            'heatmap-weight': ["/", ["to-number", ["get", "netgen_2001_0"]], 2000000]
        }
    }, 'satellite');

    map.addLayer({
        "id": "plant-circles",
        "type": "circle",
        "source": "plant-generation",
        "source-layer": "plant_generation-a4s0r8",
        "paint": {
            'circle-radius': ["interpolate",
                ["linear"],
                ["zoom"],
                8,
                0,
                16,
                ["/", ["sqrt", ["to-number", ["get", "netgen_2001_0"]]], 5]
            ],
            'circle-color': ["match", ["get", "fuel_type"],
                0, "orange",
                1, "black",
                2, "purple",
                3, "blue",
                4, "white",
                5, "yellow",
                6, "green",
                7, "grey",
                8, "red",
                9, "brown",
                "grey"
            ],
            'circle-opacity': .5
        },
        "minzoom": 8
    });

    map.addLayer({
        "id": "plant-labels",
        "source": "plant-generation",
        "source-layer": "plant_generation-a4s0r8",
        "type": "symbol",
        "minzoom": 10,
        "layout": {
            "text-field": ["format",
                ["get", "name"], {},
                "\n", {},
                ["concat", ["number-format", ["round", ["/", ["get", "netgen"], 1000]], {}], " GWh   "],
                {
                    "text-font": ["literal", ["DIN Offc Pro Bold", "Arial Unicode MS Regular"]],
                    "font-scale": 0.8
                },
                ["match", ["get", "fuel_type"],
                    0, "Gas",
                    1, "Coal",
                    2, "Nuclear",
                    3, "Hydro",
                    4, "Wind",
                    5, "Solar",
                    6, "Renewable Hydrocarbon",
                    7, "Other",
                    8, "Geothermal",
                    9, "Petroleum",
                    "(Other))"
                ],
                {
                    "text-font": ["literal", ["DIN Offc Pro Italic", "Arial Unicode MS Regular"]],
                    "font-scale": 0.8
                },
            ],
            "text-font": [ "DIN Offc Pro Medium", "Arial Unicode MS Regular" ]
        },
        "paint": {
          "text-color": "white",
          "text-halo-color": "black",
          "text-halo-width": 0.5,
          "text-halo-blur": 0.5
        }
    });
    updateFuelType();
});

toYearMonth = function(month) {
    const year = Math.floor(month / 12);
    return {
        year: 2001 + year,
        month: month - (year * 12)
    }
}

toYearQuarter = function(quarter) {
    const year = Math.floor(quarter / 4);
    return {
        year: 2001 + year,
        quarter: quarter - (year * 4)
    }
}

var updateMonth = function() {
  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ];
  const baseMonth = Math.floor(monthInput.value);
  const baseYearMonth = toYearMonth(baseMonth);

  const baseQuarter = Math.floor(baseMonth / 3);
  const nextQuarter = baseQuarter < 67 ? baseQuarter + 1 : 0;
  // Input is months but data is in quarters, so interpolate at 0, 1/3, 2/3.
  const nextMix = baseQuarter < 67 ? (baseMonth - (baseQuarter * 3)) / 3 : 0;
  const baseMix = 1 - nextMix;

  const baseYearQuarter = toYearQuarter(baseQuarter);
  const nextYearQuarter = toYearQuarter(nextQuarter);

  monthText.innerHTML = monthNames[baseYearMonth.month] + " " + baseYearMonth.year;
  yearText.innerHTML = baseYearMonth.year;

  map.setPaintProperty('generation-heatmap', 'heatmap-weight', ["/", ["+",
    ["*", ["to-number", ["get", `netgen_${baseYearQuarter.year}_${baseYearQuarter.quarter}`]], baseMix],
    ["*", ["to-number", ["get", `netgen_${nextYearQuarter.year}_${nextYearQuarter.quarter}`]], nextMix]], 2000000]);

  map.setPaintProperty('plant-circles', 'circle-radius', ["interpolate",
           ["linear"],
           ["zoom"],
           8,
           0,
           16,
           ["/", ["sqrt", ["to-number", ["get", `netgen_${baseYearMonth.year}_${baseYearMonth.month}`]]], 5]
       ]);
}

const fuelTypeWeighting = {0:1304,1:1202,2:805,3:292,4:252,5:56,6:52,7:19,8:16,9:14};
const totalGeneration = 4012;

var updateFuelType = function() {
    map.setPaintProperty('generation-heatmap', 'heatmap-intensity',
      [
        "interpolate",
        [ "exponential", 2 ],
        [ "zoom" ],
        0,
        0,
        16,
        0
      ]);
    setTimeout(() => {
        let filter = null;
        let intensityRatio = 1;
        let source = "quarterly-generation-all";
        if (fuelSelect.value != "all fuels") {
            switch(+fuelSelect.value) {
                case 0:
                    source = "quarterly-generation-gas";
                    break;
                case 1:
                    source = "quarterly-generation-coal";
                    break;
                case 2:
                    source = "quarterly-generation-nuclear";
                    break;
                case 3:
                    source = "quarterly-generation-hydro";
                    break;
                case 4:
                    source = "quarterly-generation-wind";
                    break;
                case 5:
                    source = "quarterly-generation-solar";
                    break;
                case 6:
                    source = "quarterly-generation-renewable";
                    break;
                case 7:
                    source = "quarterly-generation-other";
                    break;
                case 8:
                    source = "quarterly-generation-geothermal";
                    break;
                case 9:
                    source = "quarterly-generation-petroleum";
                    break;
                default:
                    source = "quarterly-generation-all";

            }
            intensityRatio = 0.5 * totalGeneration / fuelTypeWeighting[fuelSelect.value];
        }
        setLayerSource('generation-heatmap', source, 'geojsonLayer');
        map.setPaintProperty('generation-heatmap', 'heatmap-intensity',
          [
            "interpolate",
            [ "exponential", 2 ],
            [ "zoom" ],
            0,
            baseIntensity * intensityRatio,
            16,
            16 * baseIntensity * intensityRatio
          ]);
      }, 300);

}

var timerAnimation;

monthInput.oninput = function() {
    clearTimeout(timerAnimation);
    updateMonth();
}

fuelSelect.oninput = function() {
    updateFuelType();
}

function animationStep() {
    var currentMonth = Math.floor(monthInput.value);
    if (currentMonth == 203)
        return;

    monthInput.value = Math.min(currentMonth + 1, 203);
    updateMonth();
    timerAnimation = setTimeout(animationStep, 100);
}

function animateSlider() {
    monthInput.value = 0;
    updateMonth();
    timerAnimation = setTimeout(animationStep, 300);
}

var chapters = {
    'intro': (map) => {
        fuelSelect.value = "all fuels";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'coal': (map) => {
        fuelSelect.value = "1";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'gas': (map) => {
        fuelSelect.value = "0";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'solar': (map) => {
        fuelSelect.value = "5";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'wind': (map) => {
        fuelSelect.value = "4";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'hydro': (map) => {
        fuelSelect.value = "3";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        animateSlider();
    },
    'nuclear-solar': (map) => {
        clearTimeout(timerAnimation);
        fuelSelect.value = "all fuels";
        updateFuelType();
        map.fitBounds([[-112.9721, 33.4462], [-112.814, 33.2811]]);
        animateSlider();
    },
    'explore': (map) => {
        clearTimeout(timerAnimation);
        fuelSelect.value = "all fuels";
        updateFuelType();
        map.fitBounds([[-128, 55], [-65, 25]]);
        $(".collapse").collapse('show');
    }
};

// On every scroll event, check which element is on screen
window.onscroll = function() {
    var chapterNames = Object.keys(chapters);
    for (var i = 0; i < chapterNames.length; i++) {
        var chapterName = chapterNames[i];
        if (isElementOnScreen(chapterName)) {
            setActiveChapter(chapterName);
            break;
        }
    }
};

var activeChapterName = 'intro';
var initialStyleLoaded = false;
function setActiveChapter(chapterName) {
    if (!initialStyleLoaded) {
        // Wait for the style to load once before starting animations, but then allow animations
        // to change while style is in the middle of reloading.
        if (map.isStyleLoaded()) {
            initialStyleLoaded = true;
        } else {
            return;
        }
    }
    if (chapterName === activeChapterName)
        return;

    chapters[chapterName](map);

    document.getElementById(chapterName).setAttribute('class', 'active');
    document.getElementById(activeChapterName).setAttribute('class', '');

    activeChapterName = chapterName;
}

function isElementOnScreen(id) {
    var element = document.getElementById(id);
    var bounds = element.getBoundingClientRect();
    return bounds.top < window.innerHeight && bounds.bottom > 45;
}

</script>
</body>
</html>
